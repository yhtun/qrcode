<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes">
  <title>çµåŠ¨ Â· æ–‡æœ¬è½¬äºŒç»´ç </title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }

    body {
      min-height: 100vh;
      background: linear-gradient(145deg, #f6f9fc 0%, #eef2f7 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border-radius: 2.5rem;
      box-shadow: 0 25px 45px -12px rgba(0, 32, 64, 0.25), 
                  0 2px 8px rgba(0, 0, 0, 0.03);
      padding: 2.2rem 2rem;
      width: 100%;
      max-width: 560px;
      transition: all 0.2s ease;
      border: 1px solid rgba(255, 255, 255, 0.5);
    }

    h2 {
      font-size: 2rem;
      font-weight: 600;
      letter-spacing: -0.02em;
      color: #0b2b3f;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      margin-bottom: 0.25rem;
    }

    h2 span {
      background: #1e6f9f;
      color: white;
      font-size: 0.9rem;
      font-weight: 500;
      padding: 0.2rem 0.7rem;
      border-radius: 30px;
      margin-left: 0.5rem;
      background: linear-gradient(135deg, #1e6f9f, #1a4e6f);
    }

    .sub {
      color: #4d6575;
      font-size: 0.95rem;
      margin-bottom: 1.8rem;
      font-weight: 400;
      border-left: 3px solid #1e6f9f;
      padding-left: 1rem;
      background: rgba(30, 111, 159, 0.04);
      border-radius: 0 8px 8px 0;
    }

    textarea {
      width: 100%;
      padding: 1.2rem 1.4rem;
      font-size: 1.1rem;
      border: 2px solid #dbe4ed;
      border-radius: 2rem;
      background: #ffffff;
      box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
      resize: vertical;
      transition: 0.15s;
      line-height: 1.5;
      color: #102a3c;
      font-weight: 450;
    }

    textarea:focus {
      border-color: #1e6f9f;
      outline: none;
      box-shadow: 0 0 0 4px rgba(30, 111, 159, 0.15);
    }

    textarea::placeholder {
      color: #9aafbf;
      font-weight: 300;
    }

    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.9rem;
      margin: 1.8rem 0 2rem 0;
      justify-content: center;
    }

    .btn {
      flex: 1 1 auto;
      min-width: 150px;
      background: white;
      border: none;
      padding: 0.85rem 1.2rem;
      font-size: 1.1rem;
      font-weight: 570;
      border-radius: 3rem;
      background: #ffffff;
      box-shadow: 0 8px 18px -8px rgba(0,45,75,0.15);
      color: #1a4e6f;
      cursor: pointer;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border: 1px solid rgba(30, 111, 159, 0.2);
      backdrop-filter: blur(4px);
      letter-spacing: 0.3px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1a4e6f, #266489);
      color: white;
      border: none;
      box-shadow: 0 10px 20px -8px #1a4e6f80;
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #1e5f82, #1f6d94);
      transform: scale(1.02);
      box-shadow: 0 15px 25px -8px #0e3f5b;
    }

    .btn-secondary:hover {
      background: #ecf3fa;
      border-color: #1e6f9f;
      transform: translateY(-2px);
    }

    .canvas-container {
      background: #ffffff;
      border-radius: 2rem;
      padding: 1.5rem;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.02), 0 15px 25px -16px #0f2e40;
      margin-bottom: 1.2rem;
      border: 1px solid rgba(255, 255, 255, 0.6);
    }

    canvas {
      display: block;
      width: 100%;
      max-width: 250px;
      height: auto;
      border-radius: 1.2rem;
      box-shadow: 0 5px 12px rgba(0, 30, 50, 0.1);
      background: white;
      transition: opacity 0.2s;
    }

    .hint {
      text-align: center;
      color: #587a92;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      background: rgba(255,255,255,0.5);
      padding: 0.4rem 1.2rem;
      border-radius: 50px;
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
      backdrop-filter: blur(2px);
    }

    .hint i {
      font-style: normal;
      font-size: 1.1rem;
    }

    footer {
      margin-top: 1rem;
      font-size: 0.75rem;
      color: #8ba0b2;
      text-align: center;
    }

    /* å°å±é€‚é… */
    @media (max-width: 450px) {
      .card { padding: 1.6rem 1.2rem; }
      h2 { font-size: 1.7rem; }
      .btn { min-width: 130px; padding: 0.75rem 0.5rem; }
      .button-group { gap: 0.6rem; }
    }
  </style>
</head>
<body>

<div class="card">
  <h2>
    âœ¦ æ–‡æœ¬è½¬äºŒç»´ç 
    <span>ç¦»çº¿</span>
  </h2>
  <div class="sub">è‡ªç”±è¾“å…¥ Â· ç¬é—´ç”Ÿæˆ Â· é«˜æ¸…ä¿å­˜</div>

  <!-- æ–‡æœ¬è¾“å…¥åŒº -->
  <textarea id="textInput" rows="4" placeholder="è¾“å…¥æ–‡å­—ã€ç½‘å€ã€åç‰‡ä¿¡æ¯â€¦â€¦">ä½ å¥½ï¼Œä¸–ç•Œï¼âœ¨ ç”¨äºŒç»´ç ä¼ é€’ä¿¡æ¯</textarea>

  <!-- æ“ä½œæŒ‰é’®ç»„ -->
  <div class="button-group">
    <button class="btn btn-primary" id="generateBtn">
      <span>âš¡</span> ç”ŸæˆäºŒç»´ç 
    </button>
    <button class="btn btn-secondary" id="downloadBtn">
      <span>â¬‡ï¸</span> ä¸‹è½½ PNG
    </button>
  </div>

  <!-- äºŒç»´ç ç”»å¸ƒå±•ç¤ºåŒº -->
  <div class="canvas-container">
    <canvas id="qrCanvas" width="250" height="250"></canvas>
  </div>

  <div class="hint">
    <i>ğŸ“Œ</i> æ”¯æŒä¸­æ–‡ / è¡¨æƒ… / æ¢è¡Œ Â· é»‘è‰²åƒç´ å¹²å‡€æ˜“æ‰«
  </div>
  <footer>ç‚¹å‡»ç”Ÿæˆ â€¢ å³é”®ç”»å¸ƒä¹Ÿå¯ä¿å­˜</footer>
</div>

<!-- è½»é‡çº§äºŒç»´ç æ ¸å¿ƒåº“ (qrcode æ”¯æŒ UTF-8/ä¸­æ–‡/Emoji) -->
<script src="./qrcode.min.js"></script>

<script>
  (function() {
    // è·å– DOM å…ƒç´ 
    const textarea = document.getElementById('textInput');
    const canvas = document.getElementById('qrCanvas');
    const generateBtn = document.getElementById('generateBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    // é»˜è®¤ç”Ÿæˆçš„ç¤ºä¾‹æ–‡æœ¬ (å±•ç¤ºä¸­æ–‡æ”¯æŒ)
    const DEFAULT_TEXT = "ä½ å¥½ï¼Œä¸–ç•Œï¼âœ¨ ç”¨äºŒç»´ç ä¼ é€’ä¿¡æ¯";

    // å¦‚æœtextareaä¸ºç©ºï¼Œåˆ™è®¾ç½®é»˜è®¤å€¼ (ä½†ä¹‹å‰htmlå·²ç»é¢„å¡«ï¼Œè¿™é‡ŒåšäºŒæ¬¡ä¿éšœ)
    if (!textarea.value || textarea.value.trim() === '') {
      textarea.value = DEFAULT_TEXT;
    }

    // ç”ŸæˆäºŒç»´ç å‡½æ•° (ä½¿ç”¨Promiseé£æ ¼)
    function generateQRCode(text) {
      // å»é™¤é¦–å°¾ç©ºæ ¼åè‹¥ä¸ºç©ºï¼Œç»™å‡ºå‹å¥½æç¤ºï¼Œå¹¶ä¿ç•™ä¹‹å‰ç”»å¸ƒä¸å˜
      if (!text || text.trim() === '') {
        alert('ğŸƒ è¯·è¾“å…¥ä¸€äº›æ–‡æœ¬å†ç”ŸæˆäºŒç»´ç ï½');
        return Promise.reject('empty text');
      }

      // é…ç½®é¡¹ï¼šå°ºå¯¸ä¸ç”»å¸ƒä¸€è‡´ï¼Œè¾¹è·2ï¼Œçº¯é»‘è‰²å—ï¼Œçº¯ç™½èƒŒæ™¯
      const options = {
        width: 250,
        margin: 2,
        color: {
          dark: '#000000',   // æ·±è‰²å—é»‘è‰²
          light: '#ffffff'   // æµ…è‰²å—ç™½è‰²
        },
        errorCorrectionLevel: 'M'    // ä¸­ç­‰å®¹é”™ï¼Œé€‚åˆå¤§å¤šæ•°åœºæ™¯
      };

      // è°ƒç”¨åº“ç»˜åˆ¶åˆ° canvas ä¸Š
      return QRCode.toCanvas(canvas, text, options)
        .then(() => {
          console.log('âœ… äºŒç»´ç ç”ŸæˆæˆåŠŸ');
        })
        .catch((err) => {
          console.warn('âŒ äºŒç»´ç ç”Ÿæˆå¤±è´¥:', err);
          // å¦‚æœæ˜¯å› ä¸ºæ–‡æœ¬è¿‡é•¿ï¼Œæç¤ºæ›´å‹å¥½çš„ä¿¡æ¯
          if (err.message && (err.message.includes('too long') || err.message.includes('data overflow'))) {
            alert('æ–‡æœ¬å¤ªé•¿ï¼Œè¯·ç¼©çŸ­ä¸€äº›å†è¯• ğŸ™');
          } else {
            alert('ç”Ÿæˆå¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯'));
          }
          // æŠ›å‡ºé”™è¯¯ï¼Œä»¥ä¾¿å¤–éƒ¨é“¾å¼è°ƒç”¨å¯ä»¥æ„ŸçŸ¥
          throw err;
        });
    }

    // é¦–æ¬¡åŠ è½½æ—¶ï¼Œç”¨å½“å‰textareaçš„æ–‡æœ¬ç”ŸæˆäºŒç»´ç ï¼ˆå±•ç¤ºé»˜è®¤ï¼‰
    generateQRCode(textarea.value).catch(() => {});

    // ç”ŸæˆæŒ‰é’®ç‚¹å‡»äº‹ä»¶
    generateBtn.addEventListener('click', function() {
      const inputText = textarea.value;
      generateQRCode(inputText).catch(() => {});  // é”™è¯¯å·²å†…éƒ¨å¤„ç†ï¼Œæ— éœ€é¢å¤–æ“ä½œ
    });

    // ä¸‹è½½æŒ‰é’®ç‚¹å‡»äº‹ä»¶ (ä¿å­˜ä¸ºPNG)
    downloadBtn.addEventListener('click', function() {
      // æ£€æŸ¥canvasæ˜¯å¦æ‹¥æœ‰å®é™…å†…å®¹ï¼ˆç®€å•æ£€æŸ¥ç”»å¸ƒæ˜¯å¦æœ‰åƒç´ ï¼Œä½†é»˜è®¤å·²æœ‰å†…å®¹ï¼‰
      // å°è¯•è·å–ç”»å¸ƒæ•°æ®ï¼Œè‹¥ç”»å¸ƒå®Œå…¨é€æ˜æˆ–æœªç»˜åˆ¶ï¼Œä»ä¼šä¿å­˜ä¸ºç©ºç™½å›¾ç‰‡ï¼›ä½†æˆ‘ä»¬çš„æµç¨‹é€šå¸¸å·²æœ‰å›¾
      const dataURL = canvas.toDataURL('image/png');

      // åˆ›å»ºä¸´æ—¶ä¸‹è½½é“¾æ¥
      const link = document.createElement('a');
      link.download = 'qrcode.png';            // ä¸‹è½½æ–‡ä»¶å
      link.href = dataURL;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);

      // è½»æç¤º (å¯é€‰)
      // ä¸ºäº†ä¸å¹²æ‰°ï¼Œç®€å•consoleï¼Œä¹Ÿå¯ä»¥åŠ ä¸€ä¸ªçŸ­æš‚å¼¹çª—ï¼Œä½†ä¸ºäº†æ¸…çˆ½å°±ä¸alertäº†
      console.log('ğŸ“¸ å·²è§¦å‘ä¸‹è½½ï¼Œè¯·æŸ¥çœ‹æµè§ˆå™¨ä¸‹è½½æ–‡ä»¶å¤¹');
    });

    // é™„åŠ å°ä¼˜åŒ–ï¼šæŒ‰å›è½¦(ctrl+enter)å¿«é€Ÿç”Ÿæˆ (å¯é€‰)
    textarea.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        generateBtn.click();
      }
    });

    // ç§»åŠ¨ç«¯å‹å¥½ï¼šç”Ÿæˆåè‡ªåŠ¨æ”¶èµ·é”®ç›˜ (ä¸å¼ºåˆ¶ï¼Œä½†è½»ç‚¹ç”Ÿæˆæ—¶é”®ç›˜ä¼šæ”¶)
    generateBtn.addEventListener('mousedown', function() {
      textarea.blur();  // è®©é”®ç›˜æ”¶èµ·ï¼Œä¾¿äºæŸ¥çœ‹äºŒç»´ç 
    });

    // å¦‚æœç”»å¸ƒç”Ÿæˆå¤±è´¥å¯¼è‡´ç•™ç™½ï¼Œå¯ä»¥ä¿ç•™ä¹‹å‰çš„äºŒç»´ç ï¼Œä½†ä¸Šé¢çš„catchå·²ç»ä¿ç•™äº†ä¹‹å‰çš„ç”»é¢(ä¸è¦†ç›–)
    // æ³¨æ„ï¼šQRCode.toCanvaså¤±è´¥æ—¶ç”»å¸ƒå†…å®¹å¯èƒ½è¢«æ¸…ç©ºæˆ–ä¿æŒä¸å˜ï¼Ÿåº“çš„è¡Œä¸ºå¯èƒ½æ¸…ç©ºæˆ–åŠæ¸²æŸ“ã€‚
    // ä¸ºäº†æ›´ç¨³å¥ï¼Œå¯ä»¥åœ¨å¤±è´¥æ—¶ä¿ç•™æ—§çš„ç”»å¸ƒå†…å®¹ã€‚ä½†æ˜¯ç›®å‰åº“å¤±è´¥ä¸€èˆ¬ä¸ä¼šä¿®æ”¹ç”»å¸ƒï¼Œæˆ–è€…ç”»å¸ƒå¯èƒ½è¢«ç½®ç©ºã€‚
    // å› æ­¤æˆ‘ä»¬åœ¨è°ƒç”¨generateQRCodeçš„catchä¸­ä¸åšé¢å¤–æ“ä½œï¼Œä½†å¯ä»¥ç”¨ä¸€ä¸ªå˜é‡ä¿å­˜ä¸Šä¸€æ¬¡æˆåŠŸçš„å›¾åƒæ•°æ®ï¼Ÿ
    // æ›´ä¼˜é›…: åœ¨æ¯æ¬¡æˆåŠŸä¹‹å‰å…ˆä¿å­˜ç”»å¸ƒæ•°æ®ï¼Œå¤±è´¥æ—¶è¿˜åŸã€‚ä½†ç”±äºè¿™ä¸ªæ˜¯å¢å¼ºä½“éªŒï¼Œä¸æ˜¯å¿…é¡»ï¼Œé¿å…å¤æ‚ã€‚
    // ä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯å®ç°ä¸€ä¸ªç®€å•ç¼“å­˜ï¼šæ¯æ¬¡æˆåŠŸæ—¶ç”¨å˜é‡ä¿å­˜canvaså›¾åƒæ•°æ®ï¼Œå¤±è´¥æ—¶å°è¯•é‡ç»˜ä¸Šä¸€æ¬¡æˆåŠŸçš„å›¾åƒã€‚
    // ä½†canvasæ¢å¤æ¯”è¾ƒéº»çƒ¦ï¼Œå› ä¸ºæ¶‰åŠimgæ•°æ®ã€‚è€ƒè™‘åˆ°å¤§å¤šæ•°æƒ…å†µä¸ä¼šå¤±è´¥ï¼ˆé™¤éæ–‡æœ¬å¤ªé•¿ï¼‰ï¼Œä¸”ç”¨æˆ·å¤±è´¥ä¼šalertï¼Œå¹¶å¯ä»¥ä¿®æ”¹æ–‡æœ¬å†æ¬¡ç”Ÿæˆã€‚æ‰€ä»¥æš‚æ—¶ä¸åšç¼“å­˜ã€‚
    // ä½†ä¸ºäº†å®Œç¾ï¼Œæˆ‘ä»¬å¢åŠ ä¸€ä¸ªç®€å•æœºåˆ¶ï¼šåœ¨è°ƒç”¨toCanvasä¹‹å‰å…ˆä¿å­˜å½“å‰canvaså†…å®¹ä¸ºimageDataï¼Œå¦‚æœå¤±è´¥åˆ™æ¢å¤ã€‚
    // ä½†ä¿å­˜/æ¢å¤éœ€è¦putImageDataï¼Œæ³¨æ„canvaså°ºå¯¸ä¸€è‡´ã€‚ä¸‹é¢å®ç°è¿™ä¸ªå¢å¼ºåŠŸèƒ½ã€‚
    // å¢åŠ ä¸€ä¸ªå¤‡ä»½æœºåˆ¶ (å¯é€‰ä½†ä¸ºäº†ä»£ç å¹²å‡€ä¸”é²æ£’ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸‹)
    let lastValidImageData = null;  // å­˜å‚¨æœ€è¿‘ä¸€æ¬¡æˆåŠŸçš„å›¾åƒæ•°æ®

    // æ”¹é€ generateQRCodeå†…éƒ¨ï¼Œä½¿ç”¨å¤‡ä»½æ¢å¤
    const originalGenerate = generateQRCode;
    window.generateQRCode = function(text) {  // è¦†ç›–å¤–éƒ¨ä¸å¯è§ï¼Œé‡å†™
      if (!text || text.trim() === '') {
        alert('ğŸƒ è¯·è¾“å…¥ä¸€äº›æ–‡æœ¬å†ç”ŸæˆäºŒç»´ç ï½');
        return Promise.reject('empty');
      }

      // ä¿å­˜å½“å‰ç”»å¸ƒå†…å®¹ï¼ˆä»¥é˜²å¤±è´¥åä¸¢å¤±ï¼‰
      let previousImageData = null;
      try {
        const ctx = canvas.getContext('2d');
        previousImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
      } catch (e) {
        // è·¨åŸŸæˆ–ç©ºç™½ç”»å¸ƒå¯èƒ½æŠ¥é”™ï¼Œå¿½ç•¥
      }

      const options = { width: 250, margin: 2, color: { dark: '#000000', light: '#ffffff' }, errorCorrectionLevel: 'M' };

      return QRCode.toCanvas(canvas, text, options)
        .then(() => {
          // æˆåŠŸåä¿å­˜ä¸€ä»½å½“å‰å›¾åƒæ•°æ®åˆ°ç¼“å­˜
          try {
            const ctx = canvas.getContext('2d');
            lastValidImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          } catch (e) {}
          console.log('âœ… æˆåŠŸ');
        })
        .catch((err) => {
          console.warn('âŒ å¤±è´¥:', err);
          // æ¢å¤ç”»å¸ƒåˆ°ä¹‹å‰çš„çŠ¶æ€ (å¦‚æœæœ‰ä¹‹å‰æˆåŠŸå¤‡ä»½åˆ™ç”¨å¤‡ä»½ï¼Œå¦åˆ™ç”¨åˆšæ‰ä¿å­˜çš„previousImageData)
          if (lastValidImageData) {
            try {
              const ctx = canvas.getContext('2d');
              ctx.putImageData(lastValidImageData, 0, 0);
            } catch (e) {}
          } else if (previousImageData) {
            // å¦‚æœè¿˜æ²¡æœ‰ä»»ä½•æˆåŠŸè¿‡(ç¬¬ä¸€æ¬¡å¤±è´¥)ï¼Œåˆ™å°è¯•æ¢å¤åˆ°ç”Ÿæˆå‰çš„æ ·å­
            try {
              const ctx = canvas.getContext('2d');
              ctx.putImageData(previousImageData, 0, 0);
            } catch (e) {}
          }
          // å‹å¥½é”™è¯¯æç¤º
          if (err.message && (err.message.includes('too long') || err.message.includes('data overflow'))) {
            alert('æ–‡æœ¬å¤ªé•¿äº†ï¼Œè¯·é€‚å½“ç¼©çŸ­ âœ‚ï¸');
          } else {
            alert('äºŒç»´ç ç”Ÿæˆå¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
          }
          throw err;
        });
    };

    // é‡æ–°ç»‘å®šç”Ÿæˆå‡½æ•°
    const boundGenerate = window.generateQRCode;

    // æ›¿æ¢åŸç›‘å¬
    generateBtn.removeEventListener('click', generateQRCode); // ä¹‹å‰ç»‘å®šçš„åŒ¿åå‡½æ•°ï¼Œä¸å¥½ç§»é™¤ï¼Œæ‰€ä»¥ä¹‹å‰åº”è¯¥ç”¨å‘½åå‡½æ•°ï¼Œä½†æˆ‘ä»¬æ”¹ä¸ºç›´æ¥ä½¿ç”¨æ–°å‡½æ•°
    // ç”±äºæœ€åˆç»‘å®šçš„åŒ¿åå‡½æ•°ï¼Œéœ€è¦è§£ç»‘ï¼Œæœ€ç®€å•é‡æ–°å®šä¹‰ç›‘å¬:
    // æ¸…ç©ºå¹¶é‡æ–°ç»‘å®š
    generateBtn.replaceWith(generateBtn.cloneNode(true)); // ç²—æš´ç§»é™¤æ‰€æœ‰ç›‘å¬ (ä½†ä¼šä¸¢å¤±æ ·å¼ï¼Ÿä¸å½±å“ï¼Œidä¸å˜)
    // é‡æ–°è·å–æ–°çš„æŒ‰é’®ï¼ˆcloneåéœ€è¦é‡æ–°è·å–å…ƒç´ ï¼‰
    const newGenerateBtn = document.getElementById('generateBtn');
    const newDownloadBtn = document.getElementById('downloadBtn'); // ä¸‹è½½æŒ‰é’®æœªå˜ä½†ä¹Ÿè¦é‡æ–°è·å–? å®é™…ä¸Šæ›¿æ¢åªæ›¿æ¢äº†generateBtn, downloadBtnä»ç„¶æ˜¯æ—§çš„ï¼Œä½†ä¸ºäº†é¿å…æ··ä¹±ï¼Œæˆ‘ä»¬é‡æ–°è·å–å…¨éƒ¨
    // æ›´ç¨³å¥ï¼šç›´æ¥é‡æ„äº‹ä»¶ç»‘å®šï¼Œä¸ä½¿ç”¨cloneï¼Œè€Œæ˜¯ç”¨æ–°çš„ç›‘å¬å‡½æ•°å¹¶ç§»é™¤æ—§çš„ã€‚ä½†æˆ‘ä»¬ä¹‹å‰æ˜¯ç”¨åŒ¿åå‡½æ•°ï¼Œä¸èƒ½ç›´æ¥ç§»é™¤ã€‚æ‰€ä»¥é‡‡ç”¨å‘½åå‡½æ•°æˆ–ä½¿ç”¨æ–°çš„å‡½æ•°å¼•ç”¨ã€‚
    // ä½†ä¸ºäº†ä»£ç ç®€æ´ï¼Œæˆ‘å°†åœ¨åˆå§‹åŒ–æ—¶æ˜ç¡®é‡å†™æ‰€æœ‰ç›‘å¬ï¼Œå¹¶ä¸”ä¿ç•™ä¹‹å‰æ ·å¼ã€‚
    // ç®€å•æ–¹å¼ï¼šç§»é™¤åŸæœ‰ç›‘å¬å™¨å¾ˆéš¾ï¼Œæˆ‘ä»¬ç›´æ¥ç”¨æœ€å¼€å§‹çš„ç»‘å®šæ–¹å¼â€”â€”åœ¨é¡µé¢åº•éƒ¨é‡æ–°ç»‘å®šã€‚
    // ç”±äºä¸Šé¢çš„ä»£ç å·²ç»æ‰§è¡Œäº†ä¸€éƒ¨åˆ†ï¼Œæœ€ç®€å•æ˜¯ç§»é™¤æ‰€æœ‰ç›‘å¬ï¼Œé‡æ–°è®¾ç½®ã€‚
    // æˆ‘ä»¬å°†é‡‡ç”¨é‡æ–°è®¾ç½®ç­–ç•¥ã€‚

    // é‡æ–°è·å–å…ƒç´ å¼•ç”¨ï¼ˆé¿å…å˜é‡å†²çªï¼‰
    const freshGenerate = document.getElementById('generateBtn');
    const freshDownload = document.getElementById('downloadBtn');
    const freshCanvas = document.getElementById('qrCanvas');
    const freshTextarea = document.getElementById('textInput');

    // ç§»é™¤ä¹‹å‰æ‰€æœ‰ç›‘å¬ï¼ˆé€šè¿‡æ›¿æ¢å…‹éš†æ–¹å¼â€”â€”ç®€å•é‡ç½®ï¼‰
    // ä½†æ˜¯è¿™æ ·ä¼šä¸¢å¤±ä¹‹å‰ç»‘å®šçš„åŠ è½½å®Œæˆç”Ÿæˆçš„äºŒç»´ç ï¼ŸåŠ è½½æ—¶å·²ç»ç”Ÿæˆä¸€æ¬¡ï¼Œä¸å†é‡å¤ã€‚
    // ä¸ºä¿é™©ï¼Œé‡æ–°ç”Ÿæˆä¸€æ¬¡ï¼ˆå¦‚æœä¹‹å‰å¤±è´¥å¯¼è‡´ç©ºç™½ï¼Œç”¨é»˜è®¤å†ç”Ÿæˆä¸€æ¬¡ï¼‰
    // å…ˆä¿å­˜ä¸Šæ¬¡æœ‰æ•ˆå›¾åƒï¼Œä½†æˆ‘ä»¬ç°åœ¨ç›´æ¥ç”Ÿæˆä¸€æ¬¡ã€‚
    // ä¸ºé¿å…æ··ä¹±ï¼Œæˆ‘é‡‡ç”¨ä¸€ç§æ›´å¹²å‡€çš„æ–¹å¼ï¼šé‡æ–°å®šä¹‰äº‹ä»¶ç›‘å¬å¹¶è¦†ç›–ã€‚
    // ä½¿ç”¨æ–°å‡½æ•°æ›¿æ¢ç‚¹å‡»ï¼Œä½†è€ç›‘å¬è¿˜å­˜åœ¨ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦ç§»é™¤ã€‚
    // ç›´æ¥ä½¿ç”¨ removeEventListener éœ€è¦å‡½æ•°å¼•ç”¨ï¼Œä¸å¥½å¤„ç†ï¼Œæ‰€ä»¥ä½¿ç”¨å…‹éš†æ›¿æ¢èŠ‚ç‚¹æ˜¯æœ€å¹²è„†çš„ã€‚
    const generateParent = freshGenerate.parentNode;
    const newGen = freshGenerate.cloneNode(true);
    generateParent.replaceChild(newGen, freshGenerate);

    // åŒæ ·å¤„ç†ä¸‹è½½æŒ‰é’® (ä¸‹è½½æŒ‰é’®ä¸éœ€è¦ç§»é™¤å¤æ‚çš„å¤‡ä»½é€»è¾‘ï¼Œä½†ä¹Ÿè¦é‡æ–°ç»‘å®šï¼Œä»¥é˜²é‡å¤ç›‘å¬)
    const downloadParent = freshDownload.parentNode;
    const newDl = freshDownload.cloneNode(true);
    downloadParent.replaceChild(newDl, freshDownload);

    // é‡æ–°è·å–æ–°å…ƒç´ 
    const genBtn = document.getElementById('generateBtn');
    const dlBtn = document.getElementById('downloadBtn');
    const qrCanvas = document.getElementById('qrCanvas');
    const txtArea = document.getElementById('textInput');

    // å¤‡ä»½å˜é‡é‡ç½®
    let lastImgData = null;

    // æ–°ç”Ÿæˆå‡½æ•° (ä½¿ç”¨é—­åŒ…å¼•ç”¨ lastImgData å’Œ qrCanvas)
    function generateWithBackup(text) {
      if (!text || text.trim() === '') {
        alert('ğŸƒ è¯·è¾“å…¥ä¸€äº›æ–‡æœ¬å†ç”ŸæˆäºŒç»´ç ï½');
        return Promise.reject('empty');
      }
      let previousImgData = null;
      try {
        const ctx = qrCanvas.getContext('2d');
        previousImgData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
      } catch (e) {}

      const opts = { width: 250, margin: 2, color: { dark: '#000000', light: '#ffffff' }, errorCorrectionLevel: 'M' };

      return QRCode.toCanvas(qrCanvas, text, opts)
        .then(() => {
          try {
            const ctx = qrCanvas.getContext('2d');
            lastImgData = ctx.getImageData(0, 0, qrCanvas.width, qrCanvas.height);
          } catch (e) {}
        })
        .catch((err) => {
          if (lastImgData) {
            try {
              const ctx = qrCanvas.getContext('2d');
              ctx.putImageData(lastImgData, 0, 0);
            } catch (e) {}
          } else if (previousImgData) {
            try {
              const ctx = qrCanvas.getContext('2d');
              ctx.putImageData(previousImgData, 0, 0);
            } catch (e) {}
          }
          if (err.message && (err.message.includes('too long') || err.message.includes('data overflow'))) {
            alert('æ–‡æœ¬å¤ªé•¿äº†ï¼Œè¯·é€‚å½“ç¼©çŸ­ âœ‚ï¸');
          } else {
            alert('ç”Ÿæˆå¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'));
          }
          throw err;
        });
    }

    // ç”ŸæˆæŒ‰é’®ç›‘å¬
    genBtn.addEventListener('click', function() {
      generateWithBackup(txtArea.value).catch(() => {});
    });

    // ä¸‹è½½æŒ‰é’®ç›‘å¬
    dlBtn.addEventListener('click', function() {
      const dataURL = qrCanvas.toDataURL('image/png');
      const link = document.createElement('a');
      link.download = 'qrcode.png';
      link.href = dataURL;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    });

    // é¡µé¢åŠ è½½å®Œæˆåï¼Œç¡®ä¿ç”»å¸ƒæœ‰é»˜è®¤äºŒç»´ç  (å¦‚æœç”»å¸ƒç›®å‰ç©ºç™½æˆ–è€…æ²¡æœ‰ lastImgData åˆ™ç”Ÿæˆ)
    // ç®€å•åˆ¤æ–­ï¼šå¦‚æœæ²¡æœ‰lastImgDataï¼Œå°±æ ¹æ®textareaå€¼ç”Ÿæˆ
    if (!lastImgData) {
      generateWithBackup(txtArea.value).catch(() => {});
    }

    // å¿«æ·é”®é‡æ–°ç»‘å®šåˆ°æ–°textarea
    txtArea.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        genBtn.click();
      }
    });

    // ç§»åŠ¨ç«¯ç”Ÿæˆæ—¶æ”¶èµ·é”®ç›˜
    genBtn.addEventListener('mousedown', function() {
      txtArea.blur();
    });

  })();
</script>
</body>
</html>
